{% extends 'base/layout.html' %}

{% block title %}Install {{ plugin.name }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
    <a href="{% url 'plugins:netbox_catalog:catalog_list' %}">Plugin Catalog</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'plugins:netbox_catalog:plugin_detail' name=plugin.name %}">{{ plugin.name }}</a>
</li>
<li class="breadcrumb-item active">Install</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h4>
                    <i class="mdi mdi-download"></i>
                    {% if plugin.installed_version %}Upgrade{% else %}Install{% endif %}
                    {{ plugin.name }}
                </h4>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger">
                    <strong><i class="mdi mdi-alert-circle"></i> Installation Failed</strong>
                    <pre class="mt-2 mb-0">{{ error }}</pre>
                </div>
                {% if output %}
                <div class="alert alert-secondary">
                    <strong>Output:</strong>
                    <pre class="mt-2 mb-0">{{ output }}</pre>
                </div>
                {% endif %}
                {% endif %}

                {% if install_method == "requirements" %}
                <!-- Docker with writable requirements file -->
                <div class="alert alert-info">
                    <h5><i class="mdi mdi-docker"></i> Docker Installation</h5>
                    <p class="mb-2">This will add the package to <code>requirements-extra.txt</code>.</p>
                    <p class="mb-2">After clicking Install, you'll need to:</p>
                    <ol class="mb-0">
                        <li>Add the plugin to <code>PLUGINS</code> in <code>configuration/plugins.py</code></li>
                        <li>Restart the NetBox container: <code>docker-compose down && docker-compose up -d</code></li>
                    </ol>
                </div>
                {% elif can_install %}
                <!-- Non-Docker with pip available -->
                <div class="alert alert-info">
                    <h5><i class="mdi mdi-information"></i> Before Installing</h5>
                    <p class="mb-2">After pip installation completes, you will need to:</p>
                    <ol class="mb-0">
                        <li>Add the plugin to <code>PLUGINS</code> in <code>configuration.py</code></li>
                        <li>Run database migrations</li>
                        <li>Collect static files</li>
                        <li><strong>Restart NetBox</strong></li>
                    </ol>
                </div>
                {% else %}
                <!-- No install method available -->
                <div class="alert alert-warning">
                    <h5><i class="mdi mdi-alert"></i> Manual Installation Required</h5>
                    <p class="mb-2">Automatic installation is not available. To install manually:</p>
                    <ol class="mb-2">
                        <li>Add <code>{{ plugin.name }}{% if plugin.version %}>={{ plugin.version }}{% endif %}</code> to <code>requirements-extra.txt</code></li>
                        <li>Add the plugin to <code>PLUGINS</code> in <code>configuration/plugins.py</code></li>
                        <li>Restart the NetBox container</li>
                    </ol>
                </div>
                {% endif %}

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">Package</label>
                        <input type="text" class="form-control" value="{{ plugin.name }}" disabled>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Version</label>
                        <input type="text" class="form-control" value="{{ plugin.version }}" disabled>
                        {% if plugin.installed_version %}
                        <div class="form-text">Currently installed: v{{ plugin.installed_version }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Version to Install</label>
                        {{ form.version }}
                        <div class="form-text">Leave empty to install the latest version ({{ plugin.version }}).</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Configuration Snippet</label>
                        <pre class="bg-dark text-light p-3 rounded"><code>{{ config_snippet }}</code></pre>
                        <div class="form-text">You will need to add this to your configuration.py</div>
                    </div>

                    <div class="mb-3 form-check">
                        {{ form.confirm }}
                        <label class="form-check-label" for="id_confirm">
                            {{ form.confirm.label }}
                        </label>
                        {% if form.confirm.errors %}
                        <div class="text-danger">{{ form.confirm.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'plugins:netbox_catalog:plugin_detail' name=plugin.name %}"
                           class="btn btn-outline-secondary">Cancel</a>
                        {% if can_install %}
                        <button type="submit" class="btn btn-success">
                            <i class="mdi mdi-download"></i>
                            {% if install_method == "requirements" %}
                            Add to Requirements
                            {% elif plugin.installed_version %}
                            Upgrade {{ plugin.name }}
                            {% else %}
                            Install {{ plugin.name }}
                            {% endif %}
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-secondary" disabled>
                            <i class="mdi mdi-download"></i> Manual Install Required
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
